framework:
    messenger:
        buses:
            messenger.bus.default:
                middleware:
                    - App\Infrastructure\Symfony\Messenger\Middleware\OutputWorkerMemoryUsageMiddleware
        # Uncomment this (and the failed transport below) to send failed messages to this transport for later handling.
        # failure_transport: failed

        transports:
            # https://symfony.com/doc/current/messenger.html#transport-configuration
            service: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=service'
            async_critical: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=async_critical'
            async_high: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=async_high'
            async_low: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=async_low'
            async: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=async'
            cache: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=cache'
            tickers_updater_async: '%env(MESSENGER_TRANSPORT_DSN)%?queue_name=tickers_updater_async'
            failed: 'doctrine://default?queue_name=failed'
            sync: 'sync://'
            cron:
                dsn: 'cron://'
                retry_strategy:
                    max_retries: 0 # do not retry

        routing:
            App\Bot\Application\Messenger\Job\Cache\UpdateTicker: tickers_updater_async

            # market
            App\Screener\Application\Job\CheckSignificantPriceChangeJob: async_low
            App\Application\Messenger\Market\TransferFundingFees: async

            # orders
            App\Bot\Application\Command\Exchange\TryReleaseActiveOrders: async_high
            App\Bot\Application\Messenger\Job\Utils\FixupOrdersDoubling: async
            App\Bot\Application\Messenger\Job\Utils\MoveStops: async

            # position
            App\Watch\Application\Job\CheckMainPositionIsInLoss\CheckPositionIsInLoss: async
            App\Watch\Application\Job\CheckPositionIsInProfit\CheckPositionIsInProfit: async

            # trading
            App\Application\Messenger\Trading\CoverLossesAfterCloseByMarket\CoverLossesAfterCloseByMarketConsumerDto: async_critical
            App\Trading\Application\Job\ApplyLockInProfit\ApplyLockInProfitJob: async_high
            App\Trading\Application\Job\PeriodicalOrder\MakePeriodicalOrderJob: async_high

            # connection
            App\Connection\Application\Messenger\Job\CheckConnection: async

            # BuyOrder
#            App\Bot\Application\Messenger\Job\BuyOrder\CheckOrdersNowIsActive: async_high
            App\Bot\Application\Messenger\Job\BuyOrder\ResetBuyOrdersActiveState\ResetBuyOrdersActiveState: async_high

            # Stop
            App\Buy\Application\Command\CreateStopsAfterBuy: async_critical
            App\Stop\Application\Contract\Command\CreateBuyOrderAfterStop: async_critical

            App\Stop\Application\Job\MoveOpenedPositionStopsToBreakeven\MoveOpenedPositionStopsToBreakeven: async_high

            # liquidation
            App\Liquidation\Application\Job\RemoveStaleStops\RemoveStaleStopsMessage: async

            # watch
            App\Watch\Application\Job\CheckPassedLiquidationDistance\CheckPassedLiquidationDistance: async_high

            # stale
            # App\Bot\Application\Command\Exchange\IncreaseHedgeSupportPositionByGetProfitFromMain: async

when@test:
    framework:
        messenger:
            transports:
                # replace with your transport name here (e.g., my_transport: 'in-memory://')
                # For more Messenger testing tools, see https://github.com/zenstruck/messenger-test
                # async: 'in-memory://'
                test: 'in-memory://'
