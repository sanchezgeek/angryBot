import{d as Z,u as R,c as ee}from"./useProjects-uJIyuIIU.js";import{u as D}from"./useModal-CdLpOdnN.js";import{_ as L}from"./UserAvatar.vue_vue_type_script_setup_true_lang-D6-76LK_.js";import{u as N}from"./index-CPnWkhlj.js";import{d as z,t as le,a as W,r as d,o as P,b as M,e as s,w as m,f as i,g as k,h as $,u as r,i as h,j as H,F as G,_ as ae,k as B,l as q,c as I,m as se,n as oe}from"./app-CRxPkJhA.js";import{u as te}from"./useForm-Dhp290O1.js";import{v as C}from"./utils-Blx_SZM_.js";import{u as ne}from"./useToast-DO9eR350.js";const re={class:"flex items-center gap-2 max-w-[230px] ellipsis"},ue={class:"max-w-[120px] ellipsis"},ie={class:"ellipsis max-w-[230px]"},de={class:"ellipsis max-w-[300px] lg:max-w-[450px]"},me={class:"flex gap-2 justify-end"},pe={class:"flex flex-col-reverse md:flex-row gap-2 justify-between items-center py-2"},ce={key:0,class:"flex"},fe=z({__name:"UsersTable",props:{users:{type:Array,required:!0},projects:{type:Array,required:!0},loading:{type:Boolean,default:!1},pagination:{type:Object,required:!0},sortBy:{type:String,required:!0},sortingOrder:{type:String,default:null}},emits:["edit-user","delete-user","update:sortBy","update:sortingOrder"],setup(S,{emit:w}){const A=Z([{label:"Full Name",key:"fullname",sortable:!0},{label:"Email",key:"email",sortable:!0},{label:"Username",key:"username",sortable:!0},{label:"Role",key:"role",sortable:!0},{label:"Projects",key:"projects",sortable:!0},{label:" ",key:"actions",align:"right"}]),p=S,g=w,o=le(p,"users"),_=N(p,"sortBy",g),f=N(p,"sortingOrder",g),v={admin:"danger",user:"background-element",owner:"warning"},U=W(()=>Math.ceil(p.pagination.total/p.pagination.perPage)),{confirm:b}=D(),F=async t=>{await b({title:"Delete user",message:`Are you sure you want to delete ${t.fullname}?`,okText:"Delete",cancelText:"Cancel",size:"small",maxWidth:"380px"})&&g("delete-user",t)},O=t=>{const a=t.reduce((l,c)=>{var y;const x=(y=p.projects)==null?void 0:y.find(({id:n})=>c===n);return x&&l.push(x.project_name),l},[]);return a.length===0?"No projects":a.length<=2?a.map(l=>l).join(", "):a.slice(0,2).map(l=>l).join(", ")+" + "+(a.length-2)+" more"};return(t,a)=>{const l=d("VaBadge"),c=d("VaButton"),x=d("VaDataTable"),y=d("VaSelect"),n=d("VaPagination");return P(),M(G,null,[s(x,{"sort-by":r(_),"onUpdate:sortBy":a[0]||(a[0]=e=>h(_)?_.value=e:null),"sorting-order":r(f),"onUpdate:sortingOrder":a[1]||(a[1]=e=>h(f)?f.value=e:null),columns:r(A),items:o.value,loading:t.$props.loading},{"cell(fullname)":m(({rowData:e})=>[i("div",re,[s(L,{user:e,size:"small"},null,8,["user"]),k(" "+$(e.fullname),1)])]),"cell(username)":m(({rowData:e})=>[i("div",ue,$(e.username),1)]),"cell(email)":m(({rowData:e})=>[i("div",ie,$(e.email),1)]),"cell(role)":m(({rowData:e})=>[s(l,{text:e.role,color:v[e.role]},null,8,["text","color"])]),"cell(projects)":m(({rowData:e})=>[i("div",de,$(O(e.projects)),1)]),"cell(actions)":m(({rowData:e})=>[i("div",me,[s(c,{preset:"primary",size:"small",icon:"mso-edit","aria-label":"Edit user",onClick:j=>t.$emit("edit-user",e)},null,8,["onClick"]),s(c,{preset:"primary",size:"small",icon:"mso-delete",color:"danger","aria-label":"Delete user",onClick:j=>F(e)},null,8,["onClick"])])]),_:1},8,["sort-by","sorting-order","columns","items","loading"]),i("div",pe,[i("div",null,[i("b",null,$(t.$props.pagination.total)+" results.",1),a[6]||(a[6]=k(" Results per page ")),s(y,{modelValue:t.$props.pagination.perPage,"onUpdate:modelValue":a[2]||(a[2]=e=>t.$props.pagination.perPage=e),class:"!w-20",options:[10,50,100]},null,8,["modelValue"])]),U.value>1?(P(),M("div",ce,[s(c,{preset:"secondary",icon:"va-arrow-left","aria-label":"Previous page",disabled:t.$props.pagination.page===1,onClick:a[3]||(a[3]=e=>t.$props.pagination.page--)},null,8,["disabled"]),s(c,{class:"mr-2",preset:"secondary",icon:"va-arrow-right","aria-label":"Next page",disabled:t.$props.pagination.page===U.value,onClick:a[4]||(a[4]=e=>t.$props.pagination.page++)},null,8,["disabled"]),s(n,{modelValue:t.$props.pagination.page,"onUpdate:modelValue":a[5]||(a[5]=e=>t.$props.pagination.page=e),"buttons-preset":"secondary",pages:U.value,"visible-pages":5,"boundary-links":!1,"direction-links":!1},null,8,["modelValue","pages"])])):H("",!0)])],64)}}}),ve=ae(fe,[["__scopeId","data-v-fddfb7f3"]]),ge={class:"self-stretch flex-col justify-start items-start gap-4 flex"},Ve={class:"flex gap-4 flex-col sm:flex-row w-full"},be={class:"flex gap-4 flex-col sm:flex-row w-full"},ye={class:"flex gap-4 w-full"},we={class:"w-1/2"},xe={class:"flex items-center w-1/2 mt-4"},_e={class:"flex gap-2 flex-col-reverse items-stretch justify-end w-full sm:flex-row sm:items-center"},Ue=z({__name:"EditUserForm",props:{user:{type:Object,default:null},saveButtonLabel:{type:String,default:"Save"}},emits:["close","save"],setup(S,{expose:w,emit:A}){const p=S,g={avatar:"",fullname:"",role:"user",username:"",notes:"",email:"",active:!0,projects:[]},o=B({...g}),_=W(()=>Object.keys(o.value).some(a=>{var l;return a==="avatar"||a==="projects"?!1:o.value[a]!==((l=p.user??g)==null?void 0:l[a])}));w({isFormHasUnsavedChanges:_});const{projects:f}=R({pagination:B({page:1,perPage:9999,total:10})});q([()=>p.user,f],()=>{p.user&&(o.value={...p.user,projects:p.user.projects.filter(a=>f.value.find(({id:l})=>l===a)),avatar:p.user.avatar||""})},{immediate:!0});const v=B(),U=a=>URL.createObjectURL(a);q(v,a=>{o.value.avatar=a?U(a):""});const b=te("add-user-form"),F=A,O=()=>{b.validate()&&F("save",o.value)},t=[{text:"Admin",value:"admin"},{text:"User",value:"user"},{text:"Owner",value:"owner"}];return(a,l)=>{const c=d("VaButton"),x=d("VaFileUpload"),y=d("VaInput"),n=d("VaSelect"),e=d("VaCheckbox"),j=d("VaTextarea"),T=d("VaForm");return P(),I(T,{ref:"add-user-form",class:"flex-col justify-start items-start gap-4 inline-flex w-full"},{default:m(({isValid:E})=>[s(x,{modelValue:v.value,"onUpdate:modelValue":l[1]||(l[1]=u=>v.value=u),type:"single","hide-file-list":"",class:"self-stretch justify-start items-center gap-4 inline-flex"},{default:m(()=>[s(L,{user:o.value,size:"large"},null,8,["user"]),s(c,{preset:"primary",size:"small"},{default:m(()=>l[10]||(l[10]=[k("Add image")])),_:1}),v.value?(P(),I(c,{key:0,preset:"primary",color:"danger",size:"small",icon:"delete",class:"z-10",onClick:l[0]||(l[0]=se(u=>v.value=void 0,["stop"]))})):H("",!0)]),_:1},8,["modelValue"]),i("div",ge,[i("div",Ve,[s(y,{modelValue:o.value.fullname,"onUpdate:modelValue":l[2]||(l[2]=u=>o.value.fullname=u),label:"Full name",class:"w-full sm:w-1/2",rules:[r(C).required],name:"fullName"},null,8,["modelValue","rules"]),s(y,{modelValue:o.value.username,"onUpdate:modelValue":l[3]||(l[3]=u=>o.value.username=u),label:"Username",class:"w-full sm:w-1/2",rules:[r(C).required],name:"username"},null,8,["modelValue","rules"])]),i("div",be,[s(y,{modelValue:o.value.email,"onUpdate:modelValue":l[4]||(l[4]=u=>o.value.email=u),label:"Email",class:"w-full sm:w-1/2",rules:[r(C).required,r(C).email],name:"email"},null,8,["modelValue","rules"]),s(n,{modelValue:o.value.projects,"onUpdate:modelValue":l[5]||(l[5]=u=>o.value.projects=u),label:"Projects",class:"w-full sm:w-1/2",options:r(f),"value-by":"id","text-by":"project_name",rules:[r(C).required],name:"projects",multiple:"","max-visible-options":2},null,8,["modelValue","options","rules"])]),i("div",ye,[i("div",we,[s(n,{modelValue:o.value.role,"onUpdate:modelValue":l[6]||(l[6]=u=>o.value.role=u),label:"Role",class:"w-full",options:t,rules:[r(C).required],name:"role","value-by":"value"},null,8,["modelValue","rules"])]),i("div",xe,[s(e,{modelValue:o.value.active,"onUpdate:modelValue":l[7]||(l[7]=u=>o.value.active=u),label:"Active",class:"w-full",name:"active"},null,8,["modelValue"])])]),s(j,{modelValue:o.value.notes,"onUpdate:modelValue":l[8]||(l[8]=u=>o.value.notes=u),label:"Notes",class:"w-full",name:"notes"},null,8,["modelValue"]),i("div",_e,[s(c,{preset:"secondary",color:"secondary",onClick:l[9]||(l[9]=u=>a.$emit("close"))},{default:m(()=>l[11]||(l[11]=[k("Cancel")])),_:1}),s(c,{disabled:!E,onClick:O},{default:m(()=>[k($(S.saveButtonLabel),1)]),_:2},1032,["disabled"])])])]),_:1},512)}}}),je={class:"flex flex-col md:flex-row gap-2 mb-2 justify-between"},$e={class:"flex flex-col md:flex-row gap-2 justify-start"},Ce={class:"va-h5"},Ee=z({__name:"UsersPage",setup(S){const w=B(!1),{users:A,isLoading:p,filters:g,sorting:o,pagination:_,error:f,...v}=ee(),{projects:U}=R(),b=B(null),F=n=>{b.value=n,w.value=!0},O=()=>{b.value=null,w.value=!0},{init:t}=ne();oe(()=>{f.value&&t({message:f.value.message,color:"danger"})});const a=async n=>{if(n.avatar.startsWith("blob:")){const e=await fetch(n.avatar).then(T=>T.blob()),{publicUrl:j}=await v.uploadAvatar(e);n.avatar=j}b.value?(await v.update(n),f.value||t({message:`${n.fullname} has been updated`,color:"success"})):(await v.add(n),f.value||t({message:`${n.fullname} has been created`,color:"success"}))},l=async n=>{await v.remove(n),t({message:`${n.fullname} has been deleted`,color:"success"})},c=B(),{confirm:x}=D(),y=async n=>{c.value.isFormHasUnsavedChanges?await x({maxWidth:"380px",message:"Form has unsaved changes. Are you sure you want to close it?",size:"small"})&&n():n()};return(n,e)=>{const j=d("VaButtonToggle"),T=d("VaIcon"),E=d("VaInput"),u=d("VaButton"),J=d("VaCardContent"),K=d("VaCard"),Q=d("VaModal");return P(),M(G,null,[e[6]||(e[6]=i("h1",{class:"page-title"},"Users",-1)),s(K,null,{default:m(()=>[s(J,null,{default:m(()=>[i("div",je,[i("div",$e,[s(j,{modelValue:r(g).isActive,"onUpdate:modelValue":e[0]||(e[0]=V=>r(g).isActive=V),color:"background-element","border-color":"background-element",options:[{label:"Active",value:!0},{label:"Inactive",value:!1}]},null,8,["modelValue"]),s(E,{modelValue:r(g).search,"onUpdate:modelValue":e[1]||(e[1]=V=>r(g).search=V),placeholder:"Search"},{prependInner:m(()=>[s(T,{name:"search",color:"secondary",size:"small"})]),_:1},8,["modelValue"])]),s(u,{onClick:O},{default:m(()=>e[5]||(e[5]=[k("Add User")])),_:1})]),s(ve,{"sort-by":r(o).sortBy,"onUpdate:sortBy":e[2]||(e[2]=V=>r(o).sortBy=V),"sorting-order":r(o).sortingOrder,"onUpdate:sortingOrder":e[3]||(e[3]=V=>r(o).sortingOrder=V),users:r(A),projects:r(U),loading:r(p),pagination:r(_),onEditUser:F,onDeleteUser:l},null,8,["sort-by","sorting-order","users","projects","loading","pagination"])]),_:1})]),_:1}),s(Q,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=V=>w.value=V),size:"small","mobile-fullscreen":"","close-button":"","hide-default-actions":"","before-cancel":y},{default:m(({cancel:V,ok:X})=>[i("h1",Ce,$(b.value?"Edit user":"Add user"),1),s(Ue,{ref_key:"editFormRef",ref:c,user:b.value,"save-button-label":b.value?"Save":"Add",onClose:V,onSave:Y=>{a(Y),X()}},null,8,["user","save-button-label","onClose","onSave"])]),_:1},8,["modelValue"])],64)}}});export{Ee as default};
