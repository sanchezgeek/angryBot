import{d as Z,u as I,a as ee,v as ae}from"./useProjects-uJIyuIIU.js";import{u as L}from"./useModal-CdLpOdnN.js";import{d as z,r as p,o as O,c as N,t as te,a as R,b as E,e as s,w as V,f as v,g as h,h as S,u,i as D,j as W,F as H,_ as le,k as j,l as M,m as se,n as oe}from"./app-CRxPkJhA.js";import{u as q}from"./index-CPnWkhlj.js";import{u as re}from"./useForm-Dhp290O1.js";import{v as F}from"./utils-Blx_SZM_.js";import{u as ne}from"./useToast-DO9eR350.js";const G=z({__name:"UserAvatar",props:{user:{type:Object,required:!0},size:{type:String,default:"medium"}},setup(x){const c=n=>{const a=["primary","#FFD43A","#ADFF00","#262824","danger"],m=n.charCodeAt(0)%a.length;return a[m]},U=n=>n?n.startsWith("http")||n.startsWith("blob:"):!1,r=n=>{try{const[a,m]=n.split(" ");return`${a[0]}${m[0]}`}catch{return n[0]}};return(n,a)=>{const m=p("VaAvatar");return O(),N(m,{size:x.size,src:U(x.user.avatar)?x.user.avatar:"","fallback-text":r(x.user.fullname),color:c(x.user.fullname)},null,8,["size","src","fallback-text","color"])}}}),ue={class:"flex items-center gap-2 max-w-[230px] ellipsis"},ie={class:"max-w-[120px] ellipsis"},de={class:"ellipsis max-w-[230px]"},me={class:"ellipsis max-w-[300px] lg:max-w-[450px]"},ce={class:"flex gap-2 justify-end"},pe={class:"flex flex-col-reverse md:flex-row gap-2 justify-between items-center py-2"},fe={key:0,class:"flex"},ve=z({__name:"UsersTable",props:{users:{type:Array,required:!0},projects:{type:Array,required:!0},loading:{type:Boolean,default:!1},pagination:{type:Object,required:!0},sortBy:{type:String,required:!0},sortingOrder:{type:String,default:null}},emits:["edit-user","delete-user","update:sortBy","update:sortingOrder"],setup(x,{emit:c}){const U=Z([{label:"Full Name",key:"fullname",sortable:!0},{label:"Email",key:"email",sortable:!0},{label:"Username",key:"username",sortable:!0},{label:"Role",key:"role",sortable:!0},{label:"Projects",key:"projects",sortable:!0},{label:" ",key:"actions",align:"right"}]),r=x,n=c,a=te(r,"users"),m=q(r,"sortBy",n),b=q(r,"sortingOrder",n),y={admin:"danger",user:"background-element",owner:"warning"},g=R(()=>Math.ceil(r.pagination.total/r.pagination.perPage)),{confirm:i}=L(),$=async o=>{await i({title:"Delete user",message:`Are you sure you want to delete ${o.fullname}?`,okText:"Delete",cancelText:"Cancel",size:"small",maxWidth:"380px"})&&n("delete-user",o)},k=o=>{const t=o.reduce((l,w)=>{var C;const B=(C=r.projects)==null?void 0:C.find(({id:d})=>w===d);return B&&l.push(B.project_name),l},[]);return t.length===0?"No projects":t.length<=2?t.map(l=>l).join(", "):t.slice(0,2).map(l=>l).join(", ")+" + "+(t.length-2)+" more"};return(o,t)=>{const l=p("VaBadge"),w=p("VaButton"),B=p("VaDataTable"),C=p("VaSelect"),d=p("VaPagination");return O(),E(H,null,[s(B,{"sort-by":u(m),"onUpdate:sortBy":t[0]||(t[0]=e=>D(m)?m.value=e:null),"sorting-order":u(b),"onUpdate:sortingOrder":t[1]||(t[1]=e=>D(b)?b.value=e:null),columns:u(U),items:a.value,loading:o.$props.loading},{"cell(fullname)":V(({rowData:e})=>[v("div",ue,[s(G,{user:e,size:"small"},null,8,["user"]),h(" "+S(e.fullname),1)])]),"cell(username)":V(({rowData:e})=>[v("div",ie,S(e.username),1)]),"cell(email)":V(({rowData:e})=>[v("div",de,S(e.email),1)]),"cell(role)":V(({rowData:e})=>[s(l,{text:e.role,color:y[e.role]},null,8,["text","color"])]),"cell(projects)":V(({rowData:e})=>[v("div",me,S(k(e.projects)),1)]),"cell(actions)":V(({rowData:e})=>[v("div",ce,[s(w,{preset:"primary",size:"small",icon:"mso-edit","aria-label":"Edit user",onClick:A=>o.$emit("edit-user",e)},null,8,["onClick"]),s(w,{preset:"primary",size:"small",icon:"mso-delete",color:"danger","aria-label":"Delete user",onClick:A=>$(e)},null,8,["onClick"])])]),_:1},8,["sort-by","sorting-order","columns","items","loading"]),v("div",pe,[v("div",null,[v("b",null,S(o.$props.pagination.total)+" results.",1),t[6]||(t[6]=h(" Results per page ")),s(C,{modelValue:o.$props.pagination.perPage,"onUpdate:modelValue":t[2]||(t[2]=e=>o.$props.pagination.perPage=e),class:"!w-20",options:[10,50,100]},null,8,["modelValue"])]),g.value>1?(O(),E("div",fe,[s(w,{preset:"secondary",icon:"va-arrow-left","aria-label":"Previous page",disabled:o.$props.pagination.page===1,onClick:t[3]||(t[3]=e=>o.$props.pagination.page--)},null,8,["disabled"]),s(w,{class:"mr-2",preset:"secondary",icon:"va-arrow-right","aria-label":"Next page",disabled:o.$props.pagination.page===g.value,onClick:t[4]||(t[4]=e=>o.$props.pagination.page++)},null,8,["disabled"]),s(d,{modelValue:o.$props.pagination.page,"onUpdate:modelValue":t[5]||(t[5]=e=>o.$props.pagination.page=e),"buttons-preset":"secondary",pages:g.value,"visible-pages":5,"boundary-links":!1,"direction-links":!1},null,8,["modelValue","pages"])])):W("",!0)])],64)}}}),ge=le(ve,[["__scopeId","data-v-ff86ec2c"]]),be={class:"self-stretch flex-col justify-start items-start gap-4 flex"},Ve={class:"flex gap-4 flex-col sm:flex-row w-full"},ye={class:"flex gap-4 flex-col sm:flex-row w-full"},we={class:"flex gap-4 w-full"},xe={class:"w-1/2"},Ue={class:"flex items-center w-1/2 mt-4"},_e={class:"flex gap-2 flex-col-reverse items-stretch justify-end w-full sm:flex-row sm:items-center"},je=z({__name:"EditUserForm",props:{user:{type:Object,default:null},saveButtonLabel:{type:String,default:"Save"}},emits:["close","save"],setup(x,{expose:c,emit:U}){const r=x,n={avatar:"",fullname:"",role:"user",username:"",notes:"",email:"",active:!0,projects:[]},a=j({...n}),m=R(()=>Object.keys(a.value).some(t=>{var l;return t==="avatar"||t==="projects"?!1:a.value[t]!==((l=r.user??n)==null?void 0:l[t])}));c({isFormHasUnsavedChanges:m});const{projects:b}=I({pagination:j({page:1,perPage:9999,total:10})});M([()=>r.user,b],()=>{r.user&&(a.value={...r.user,projects:r.user.projects.filter(t=>b.value.find(({id:l})=>l===t)),avatar:r.user.avatar||""})},{immediate:!0});const y=j(),g=t=>URL.createObjectURL(t);M(y,t=>{a.value.avatar=t?g(t):""});const i=re("add-user-form"),$=U,k=()=>{i.validate()&&$("save",a.value)},o=[{text:"Admin",value:"admin"},{text:"User",value:"user"},{text:"Owner",value:"owner"}];return(t,l)=>{const w=p("VaButton"),B=p("VaFileUpload"),C=p("VaInput"),d=p("VaSelect"),e=p("VaCheckbox"),A=p("VaTextarea"),P=p("VaForm");return O(),N(P,{ref:"add-user-form",class:"flex-col justify-start items-start gap-4 inline-flex w-full"},{default:V(({isValid:T})=>[s(B,{modelValue:y.value,"onUpdate:modelValue":l[1]||(l[1]=f=>y.value=f),type:"single","hide-file-list":"",class:"self-stretch justify-start items-center gap-4 inline-flex"},{default:V(()=>[s(G,{user:a.value,size:"large"},null,8,["user"]),s(w,{preset:"primary",size:"small"},{default:V(()=>l[10]||(l[10]=[h("Add image")])),_:1}),y.value?(O(),N(w,{key:0,preset:"primary",color:"danger",size:"small",icon:"delete",class:"z-10",onClick:l[0]||(l[0]=se(f=>y.value=void 0,["stop"]))})):W("",!0)]),_:1},8,["modelValue"]),v("div",be,[v("div",Ve,[s(C,{modelValue:a.value.fullname,"onUpdate:modelValue":l[2]||(l[2]=f=>a.value.fullname=f),label:"Full name",class:"w-full sm:w-1/2",rules:[u(F).required],name:"fullName"},null,8,["modelValue","rules"]),s(C,{modelValue:a.value.username,"onUpdate:modelValue":l[3]||(l[3]=f=>a.value.username=f),label:"Username",class:"w-full sm:w-1/2",rules:[u(F).required],name:"username"},null,8,["modelValue","rules"])]),v("div",ye,[s(C,{modelValue:a.value.email,"onUpdate:modelValue":l[4]||(l[4]=f=>a.value.email=f),label:"Email",class:"w-full sm:w-1/2",rules:[u(F).required,u(F).email],name:"email"},null,8,["modelValue","rules"]),s(d,{modelValue:a.value.projects,"onUpdate:modelValue":l[5]||(l[5]=f=>a.value.projects=f),label:"Projects",class:"w-full sm:w-1/2",options:u(b),"value-by":"id","text-by":"project_name",rules:[u(F).required],name:"projects",multiple:"","max-visible-options":2},null,8,["modelValue","options","rules"])]),v("div",we,[v("div",xe,[s(d,{modelValue:a.value.role,"onUpdate:modelValue":l[6]||(l[6]=f=>a.value.role=f),label:"Role",class:"w-full",options:o,rules:[u(F).required],name:"role","value-by":"value"},null,8,["modelValue","rules"])]),v("div",Ue,[s(e,{modelValue:a.value.active,"onUpdate:modelValue":l[7]||(l[7]=f=>a.value.active=f),label:"Active",class:"w-full",name:"active"},null,8,["modelValue"])])]),s(A,{modelValue:a.value.notes,"onUpdate:modelValue":l[8]||(l[8]=f=>a.value.notes=f),label:"Notes",class:"w-full",name:"notes"},null,8,["modelValue"]),v("div",_e,[s(w,{preset:"secondary",color:"secondary",onClick:l[9]||(l[9]=f=>t.$emit("close"))},{default:V(()=>l[11]||(l[11]=[h("Cancel")])),_:1}),s(w,{disabled:!T,onClick:k},{default:V(()=>[h(S(x.saveButtonLabel),1)]),_:2},1032,["disabled"])])])]),_:1},512)}}}),$e=()=>j({page:1,perPage:10,total:0}),ke=()=>j({sortBy:"fullname",sortingOrder:null}),Ce=()=>j({isActive:!0,search:""}),Be=x=>{const c=j(!1),U=j(),r=ee(),{filters:n=Ce(),sorting:a=ke(),pagination:m=$e()}={},b=async()=>{c.value=!0;try{await r.getAll({filters:u(n),sorting:u(a),pagination:u(m)}),m.value=r.pagination}finally{c.value=!1}};M(n,()=>{m.value.page=1,b()},{deep:!0}),b();const y=R(()=>{const g=($,k)=>k==="projects"?$.projects.map(o=>o).join(", "):$[k],i=r.items.slice((m.value.page-1)*m.value.perPage,m.value.page*m.value.perPage);return a.value.sortBy&&a.value.sortingOrder&&i.sort(($,k)=>{const o=g($,a.value.sortBy),t=g(k,a.value.sortBy);return o>t?a.value.sortingOrder==="asc"?1:-1:o<t?a.value.sortingOrder==="asc"?-1:1:0}),i});return{error:U,isLoading:c,filters:n,sorting:a,pagination:m,users:y,fetch:b,async add(g){c.value=!0;try{return await r.add(g)}catch(i){U.value=i}finally{c.value=!1}},async update(g){c.value=!0;try{return await r.update(g)}catch(i){U.value=i}finally{c.value=!1}},async remove(g){c.value=!0;try{return await r.remove(g)}catch(i){U.value=i}finally{c.value=!1}},async uploadAvatar(g){const i=new FormData;return i.append("avatar",g),i.append("id",ae()),r.uploadAvatar(i)}}},Ae={class:"flex flex-col md:flex-row gap-2 mb-2 justify-between"},Se={class:"flex flex-col md:flex-row gap-2 justify-start"},Fe={class:"va-h5"},Me=z({__name:"SettingPage",setup(x){const c=j(!1),{users:U,isLoading:r,filters:n,sorting:a,pagination:m,error:b,...y}=Be(),{projects:g}=I(),i=j(null),$=d=>{i.value=d,c.value=!0},k=()=>{i.value=null,c.value=!0},{init:o}=ne();oe(()=>{b.value&&o({message:b.value.message,color:"danger"})});const t=async d=>{if(d.avatar.startsWith("blob:")){const e=await fetch(d.avatar).then(P=>P.blob()),{publicUrl:A}=await y.uploadAvatar(e);d.avatar=A}i.value?(await y.update(d),b.value||o({message:`${d.fullname} has been updated`,color:"success"})):(await y.add(d),b.value||o({message:`${d.fullname} has been created`,color:"success"}))},l=async d=>{await y.remove(d),o({message:`${d.fullname} has been deleted`,color:"success"})},w=j(),{confirm:B}=L(),C=async d=>{w.value.isFormHasUnsavedChanges?await B({maxWidth:"380px",message:"Form has unsaved changes. Are you sure you want to close it?",size:"small"})&&d():d()};return(d,e)=>{const A=p("VaButtonToggle"),P=p("VaIcon"),T=p("VaInput"),f=p("VaButton"),J=p("VaCardContent"),K=p("VaCard"),Q=p("VaModal");return O(),E(H,null,[e[6]||(e[6]=v("h1",{class:"page-title"},"Users",-1)),s(K,null,{default:V(()=>[s(J,null,{default:V(()=>[v("div",Ae,[v("div",Se,[s(A,{modelValue:u(n).isActive,"onUpdate:modelValue":e[0]||(e[0]=_=>u(n).isActive=_),color:"background-element","border-color":"background-element",options:[{label:"Active",value:!0},{label:"Inactive",value:!1}]},null,8,["modelValue"]),s(T,{modelValue:u(n).search,"onUpdate:modelValue":e[1]||(e[1]=_=>u(n).search=_),placeholder:"Search"},{prependInner:V(()=>[s(P,{name:"search",color:"secondary",size:"small"})]),_:1},8,["modelValue"])]),s(f,{onClick:k},{default:V(()=>e[5]||(e[5]=[h("Add User")])),_:1})]),s(ge,{"sort-by":u(a).sortBy,"onUpdate:sortBy":e[2]||(e[2]=_=>u(a).sortBy=_),"sorting-order":u(a).sortingOrder,"onUpdate:sortingOrder":e[3]||(e[3]=_=>u(a).sortingOrder=_),users:u(U),projects:u(g),loading:u(r),pagination:u(m),onEditUser:$,onDeleteUser:l},null,8,["sort-by","sorting-order","users","projects","loading","pagination"])]),_:1})]),_:1}),s(Q,{modelValue:c.value,"onUpdate:modelValue":e[4]||(e[4]=_=>c.value=_),size:"small","mobile-fullscreen":"","close-button":"","hide-default-actions":"","before-cancel":C},{default:V(({cancel:_,ok:X})=>[v("h1",Fe,S(i.value?"Edit user":"Add user"),1),s(je,{ref_key:"editFormRef",ref:w,user:i.value,"save-button-label":i.value?"Save":"Add",onClose:_,onSave:Y=>{t(Y),X()}},null,8,["user","save-button-label","onClose","onSave"])]),_:1},8,["modelValue"])],64)}}});export{Me as default};
