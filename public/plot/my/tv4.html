<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TradingView Widget with Price Level</title>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.1.js"></script>
<!--  <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>-->
  <script type="text/javascript" src="https://example.com/charting_library/charting_library.standalone.js"></script>
</head>
<body>
<!-- TradingView Widget BEGIN -->
<div id="tradingview-widget">sdfsdf
</div>

</body>



<script type="text/javascript">

  let tvWidget = new TradingView.widget({
    "container_id": "tradingview-widget",
    "autosize": false,
    "symbol": "NASDAQ:AAPL",
    "interval": "D",
    "timezone": "Etc/UTC",
    "theme": "Light",
    "style": "1", // "1" означает свечной стиль графика
    "toolbar_bg": "#f1f3f6",
    "enable_publishing": false,
    "hide_side_toolbar": false,
    "allow_symbol_change": true,
    "show_popup_button": true,
    "popup_width": "1000",
    "popup_height": "650"
  });

  // tvWidget.onChartReady(() => {
  //   console.log('sdf2')
  //   // const chart = widget.chart();
  //   //
  //   // chart.createShape({
  //   //   price: priceLevel,
  //   //   lock: false,
  //   //   disableSave: true,
  //   //   overrides: {
  //   //     "linecolor": "#FF0000",
  //   //     "linewidth": 2,
  //   //   },
  //   //   text: '1000',
  //   //   time: chart.symbol(),
  //   //   pane: 0,
  //   //   shape: "horizontal_line"
  // // });
  // });
  //
  tvWidget.ready(function () {

    console.log(tvWidget.activeChart)

    // const widgetContainer = document.querySelector('#tradingview-widget iframe');
    // const widgetIframeWindow = widgetContainer;
    // console.log(widgetIframeWindow)

    // console.log(tvWidget.chart)
    // console.log(tvWidget.createShape)
    //   const chart = widgetIframeWindow.TradingView.chart();
    //   chart.createShape({
    //     type: 'hline',
    //     price: priceLevel,
    //     title: Level ${priceLevel},
    //     overrides: {
    //       linecolor: '#ff0000',
    //       linewidth: 2,
    //       linestyle: 0
    //     }
    //   }, true);
  })

  //
  // $(document).ready(function(){
  //   const widgetContainer = $('#tradingview-widget').get();
  //   console.log(widgetContainer)
  //   const widgetIframeWindow = widgetContainer.contentWindow;
  //   console.log(widgetIframeWindow)
  // })
  //



  // const widgetIframeWindow = tvWidget.iframe.contentWindow;
  // console.log(widgetIframeWindow)
  //
  // widgetIframeWindow.onready(function() {
  //   console.log('sdf')
  // });


  // Добавление горизонтальной линии после загрузки виджета
  function addHorizontalLine() {
    const widgetContainer = document.querySelector('#tradingview-widget iframe');
    const widgetIframeWindow = widgetContainer.contentWindow;
    console.log(widgetIframeWindow)
    //
    // widgetIframeWindow.TradingView.onready(function() {
    //   const chart = widgetIframeWindow.TradingView.chart();
    //   chart.createShape({
    //     type: 'hline',
    //     price: priceLevel,
    //     title: Level ${priceLevel},
    //     overrides: {
    //       linecolor: '#ff0000',
    //       linewidth: 2,
    //       linestyle: 0
    //     }
    //   }, true);
    // });
  }

  // Проверка загрузки виджета и добавление линии
  window.addEventListener('message', function(event) {
    if (event.data.name === 'tv-widget-load') {
      // event.currentTarget.TradingView.chart.onready(function () {
      //   console.log('dsf');
      // });

      // window.onready(function() {
      //   console.log(event.currentTarget.TradingView.chart)
      event.currentTarget.TradingView.onready(function() {
        console.log('sdf')
      })
        // event.currentTarget.TradingView.widget.ready(function (){
        //   console.log('sdf')
        // })
      // });

      // addHorizontalLine();
    }
  });

  //
  // function initOnReady() {
  //   var widget = window.tvWidget = new TradingView.widget({
  //     library_path: "https://charting-library.tradingview-widget.com/charting_library/",
  //     // debug: true, // uncomment this line to see Library errors and warnings in the console
  //     fullscreen: true,
  //     symbol: 'AAPL',
  //     interval: '1D',
  //     container: "tv_chart_container",
  //     // datafeed: new Datafeeds.UDFCompatibleDatafeed("https://demo-feed-data.tradingview.com"),
  //     locale: "en",
  //     disabled_features: [],
  //     enabled_features: [],
  //   });
  // };
  //
  // window.addEventListener('DOMContentLoaded', initOnReady, false);
</script>
</html>
